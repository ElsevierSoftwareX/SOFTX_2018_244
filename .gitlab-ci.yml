variables:
  DOCKER_TAG_DEV: ${CI_COMMIT_REF_NAME}
  DOCKER_IMAGE_DEV: dpsim-dev
  DOCKER_IMAGE_WEB: dpsim-web
  GIT_SUBMODULE_STRATEGY: recursive

stages:
  - prepare
  - build
  - docs
  - deploy

docker:
  stage: prepare
  script:
    - docker build -t ${DOCKER_IMAGE_DEV}:${DOCKER_TAG_DEV} .
    - docker images
  tags:
    - shell

build:
  stage: build
  script:
    - mkdir build
    - cd build
    - cmake ..
    - make -j 8
  image: ${DOCKER_IMAGE_DEV}:${DOCKER_TAG_DEV}
  artifacts:
    paths:
      - build
  tags:
    - docker

docs:
  stage: docs
  script:
    - cd build
    - cmake ..
    - make docs
    - make docs_cxx
  image: ${DOCKER_IMAGE_DEV}:${DOCKER_TAG_DEV}
  artifacts:
    paths:
      - build/Documentation/html
      - build/Documentation/Cxx/html
  tags:
    - docker
    
deploy:
  stage: deploy
  script:
    - docker build -f Dockerfile.webdoc -t ${DOCKER_IMAGE_WEB}:${DOCKER_TAG_DEV} .
    - docker images
    - docker container stop dpsim-webdoc
    - docker container rm dpsim-webdoc
    - docker run --name dpsim-webdoc -d -p 8080:80 ${DOCKER_IMAGE_WEB}:${DOCKER_TAG_DEV}
  tags:
    - shell
